package com.ttulka.security;

import java.nio.file.Files;
import java.nio.file.Path;

import com.ttulka.security.sample.Vulnerable;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

import static com.ttulka.security.SerializationUtils.deserialize;
import static com.ttulka.security.SerializationUtils.serialize;
import static java.util.concurrent.TimeUnit.SECONDS;
import static org.awaitility.Awaitility.await;

class ExploitTest {

    @Test
    void exploit_is_executed(@TempDir Path tempDir) throws Exception {
        Path hackedFile = tempDir.resolve("_YOU_HAVE_BEEN_HACKED_");

        Vulnerable vulnerable = new Vulnerable();
        vulnerable.setObject(new Object());
        vulnerable.setProperty("ignored");

        Vulnerable exploited = new Exploit("mkdir " + hackedFile.toAbsolutePath())
                .exploited(vulnerable);

        Path serFile = tempDir.resolve("exploit.ser");

        serialize(exploited, serFile);
        try {
            deserialize(serFile);

        } catch (Exception ignore) {
        }

        await().atMost(2, SECONDS)
                .until(() -> Files.exists(hackedFile));
    }
}
